

# TURBOTA — Автоматизація вигрузки Shopify → Маркетплейси

## Огляд проєкту
Система для автоматичної генерації XML/YML-фідів з товарами Shopify для трьох українських маркетплейсів (Rozetka, MAUDAU, Epicentr). Включає простий адмін-інтерфейс для управління налаштуваннями та бекенд на Supabase Edge Functions для генерації фідів.

---

## Фаза 1: Інфраструктура та конфігурація

### 1.1 Підключення Shopify
- Інтеграція з Shopify Store для доступу до товарів, варіантів, цін, залишків, фото, метаполів

### 1.2 База даних (Supabase)
- **Таблиця `marketplace_config`** — налаштування кожного маркетплейсу (назва, URL фіду, глобальний multiplier, активність)
- **Таблиця `category_mapping`** — відповідність Shopify collection → categoryId/portal_id для кожного маркетплейсу
- **Таблиця `price_multipliers`** — коефіцієнти націнки: глобальний, по маркетплейсу, по категорії (наприклад: свічки +15%, дифузори +20%)
- **Таблиця `feed_logs`** — логи генерації фідів (час, кількість товарів, помилки, статус)
- **Таблиця `validation_errors`** — товари, що не пройшли валідацію (причина, SKU, дата)

---

## Фаза 2: Генерація XML-фідів (Edge Functions)

### 2.1 Основний движок генерації
- Edge Function, яка отримує товари з Shopify API
- Фільтрація: виключає draft, товари без фото, без категорії, з price=0
- Кожен варіант = окремий `<offer>`
- Валідація обов'язкових полів перед включенням в фід

### 2.2 Цінова логіка
- `marketplace_price = shopify_price × multiplier`
- Пріоритет multiplier: категорія → маркетплейс → глобальний
- Застосовується до `price` та `old_price` (compare_at_price)
- Валідація: old_price ≥ price, multiplier > 0
- Налаштовуване округлення (математичне, до .99, до 5/10)

### 2.3 Мовна стратегія
- Основна мова — українська (з Shopify)
- Для `name_ru` та `description_ru` (обов'язкові для MAUDAU): дублюється українська версія як fallback
- В адмін-панелі можна буде бачити товари без перекладів

### 2.4 Три окремі ендпоінти для фідів
- `/feed-rozetka` — YML з CDATA, Rozetka-специфічна структура
- `/feed-maudau` — YML без CDATA, portal_id, обов'язкові name_ru/description_ru
- `/feed-epicentr` — YML з paramcode/valuecode

Кожен фід генерується за статичним URL, який не змінюється.

---

## Фаза 3: Автоматичне оновлення

### 3.1 Cron-розклад
- Автоматичне оновлення фідів кожну годину через pg_cron
- Логування кожного запуску (час, кількість товарів, помилки)

### 3.2 Ручний запуск
- Кнопка в адмін-панелі для негайної перегенерації фідів

---

## Фаза 4: Адмін-панель (простий UI)

### 4.1 Дашборд
- Статус кожного маркетплейсу (останнє оновлення, кількість товарів, помилки)
- Посилання на фід-URL для кожного маркетплейсу

### 4.2 Управління цінами
- Зміна глобального multiplier
- Зміна multiplier по маркетплейсу
- Зміна multiplier по категорії
- Вибір правила округлення
- Превʼю: як виглядає ціна після множення (приклад)

### 4.3 Mapping категорій
- Таблиця: Shopify collection ↔ categoryId (Rozetka) / portal_id (MAUDAU) / Epicentr ID
- Можливість редагувати mapping без програміста

### 4.4 Логи та валідація
- Список останніх генерацій фідів
- Список товарів, що не пройшли валідацію (без фото, без категорії тощо)
- Кнопка "Оновити зараз"

### 4.5 Превʼю фіду
- Можливість переглянути згенерований XML для перевірки перед публікацією

---

## Що НЕ входить у цей етап
- Обробка замовлень з маркетплейсів
- Зворотня синхронізація даних
- Автоматичний переклад на російську
- Автоматичне оновлення категорій через API маркетплейсів
- Повноцінна мультимовна підтримка

---

## Критерії успіху
1. Всі 3 маркетплейси приймають фід без критичних помилок
2. Оновлення працює автоматично щогодини без збоїв
3. Команда може змінити multiplier та mapping категорій через UI
4. Новий товар у Shopify автоматично з'являється у фіді при наступному оновленні
5. Логи показують статус кожної генерації

